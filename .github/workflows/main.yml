name: App Store Review Guidelines History
on:
  schedule:
    - cron: '0 0,8,16 * * *'
jobs:
  build:
    runs-on: macOS-latest
    steps:
      - name: Git check-out
        uses: actions/checkout@master
      - name: Setup node
        uses: actions/setup-node@master
        with:
          node-version: '12.x'
      - name: Install npm packages
        run: npm install
      - name: Check updates
        run: npm start
      - name: Git check-in
        id: git-check-in
        if: success()
        env:
          GIT_OWNER_EMAIL: ${{ secrets.GIT_OWNER_EMAIL }}
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          git config user.email "$GIT_OWNER_EMAIL"
          git config user.name "cafedeichi"
          if [[ `git status --porcelain` ]]; then
              git add .
              git commit -a -m "Updated some contents."
              git remote rm origin
              git remote add origin https://cafedeichi:$PUSH_TOKEN@github.com/cafedeichi/AppStoreReviewGuidelinesHistory.git
              git push origin HEAD:master
              echo "Updates found."
              echo ::set-output name=updated::true
          else
              echo "Updates not found."
              echo ::set-output name=updated::false
          fi
      - name: Slack notification
        if: success() && steps.git-check-in.outputs.updated == 'true'
        env:
          CHANNEL: "#ios_knowledge"
          USERNAME: "App Store Review Guidelines History"
          ICON_EMOJI: ":apple:"
          TEXT_TITLE: "Updates found."
          TEXT_BODY: "https://github.com/cafedeichi/AppStoreReviewGuidelinesHistory/commits/master"          
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}          
        run: |
          curl -X POST \
          --data-urlencode \
          "payload={\"channel\": \"$CHANNEL\", \"username\": \"$USERNAME\", \"text\": \"$TEXT_TITLE\n$TEXT_BODY\", \"icon_emoji\": \"$ICON_EMOJI\"}" \
          "$WEBHOOK_URL"
